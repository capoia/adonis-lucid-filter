{"version":3,"sources":["../configure.ts","../src/base_model.ts","../src/mixin.ts"],"sourcesContent":["/*\n * adonis-lucid-filter\n *\n * (c) Lookin Anton <alf@lookinlab.ru>\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\nimport type Configure from '@adonisjs/core/commands/configure'\n\nexport async function configure(command: Configure) {\n  const codemods = await command.createCodemods()\n\n  await codemods.updateRcFile((rcFile) => {\n    rcFile.addProvider('adonis-lucid-filter/provider')\n    rcFile.addCommand('adonis-lucid-filter/commands')\n  })\n}\n","/*\n * adonis-lucid-filter\n *\n * (c) Lookin Anton <alf@lookinlab.ru>\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\nimport camelCase from 'lodash/camelCase.js'\nimport type { LucidFilter, LucidFilterContract } from './types/filter.js'\n\nfunction StaticImplements<T>() {\n  return (_t: T) => {}\n}\n\n/**\n * Class to filtering AdonisJS Lucid ORM\n *\n * @class BaseModelFilter\n * @constructor\n */\n@StaticImplements<LucidFilterContract>()\nexport class BaseModelFilter implements LucidFilter {\n  declare ['constructor']: typeof BaseModelFilter\n  declare $blacklist: string[]\n\n  static blacklist: string[] = []\n  static dropId: boolean = true\n  static camelCase: boolean = true\n\n  setup?($query: any): void\n\n  constructor(\n    public $query: any,\n    public $input: object\n  ) {\n    this.$input = BaseModelFilter.removeEmptyInput(this.$input)\n    this.$blacklist = this.constructor.blacklist\n  }\n\n  handle(): any {\n    if (this.setup && typeof this.setup === 'function') {\n      this.setup(this.$query)\n    }\n    this.$filterByInput()\n\n    return this.$query\n  }\n\n  whitelistMethod(method: string): boolean {\n    const index = this.$blacklist.indexOf(method)\n\n    const isBlacklisted = index !== -1\n    if (isBlacklisted) this.$blacklist.splice(index, 1)\n\n    return isBlacklisted\n  }\n\n  $filterByInput(): void {\n    for (const key in this.$input) {\n      const method = this.$getFilterMethod(key)\n\n      const keyName = key as keyof typeof this.$input\n      const value: unknown = this.$input[keyName]\n\n      if (this.$methodIsCallable(method)) {\n        ;(this[method as keyof this] as Function)(value)\n      }\n    }\n  }\n\n  $getFilterMethod(key: string): string {\n    const methodName = this.constructor.dropId ? key.replace(/^(.*)(_id|Id)$/, '$1') : key\n    return this.constructor.camelCase ? camelCase(methodName) : methodName\n  }\n\n  static removeEmptyInput(input: object): object {\n    const filteredInput = {}\n\n    for (const key in input) {\n      const keyName = key as keyof typeof input\n      const value = input[keyName]\n\n      if (value !== '' && value !== null && value !== undefined) {\n        filteredInput[keyName] = value\n      }\n    }\n    return filteredInput\n  }\n\n  $methodIsCallable(method: string): boolean {\n    const methodKey = method as keyof this\n\n    return (\n      !!this[methodKey] &&\n      typeof this[methodKey] === 'function' &&\n      !this.$methodIsBlacklisted(method)\n    )\n  }\n\n  $methodIsBlacklisted(method: string): boolean {\n    return this.$blacklist.includes(method)\n  }\n}\nexport default BaseModelFilter\n","/*\n * adonis-lucid-filter\n *\n * (c) Lookin Anton <alf@lookinlab.ru>\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\nimport type { NormalizeConstructor } from '@adonisjs/core/types/helpers'\nimport type { BaseModel } from '@adonisjs/lucid/orm'\nimport type { InputObject, LucidFilterContract } from 'adonis-lucid-filter/types/filter'\nimport type {\n  ModelQueryBuilderContract,\n  QueryScope,\n  QueryScopeCallback,\n} from '@adonisjs/lucid/types/model'\n\nexport const Filterable = <Model extends NormalizeConstructor<typeof BaseModel>>(\n  superclass: Model\n) => {\n  class FilterableModel extends superclass {\n    declare static $filter: () => LucidFilterContract\n\n    /**\n     * Filter method of filterable model\n     */\n    static filter<\n      T extends typeof FilterableModel,\n      Filter extends LucidFilterContract = ReturnType<T['$filter']>,\n    >(\n      this: T,\n      input: InputObject<InstanceType<Filter>>,\n      filter?: Filter\n    ): ModelQueryBuilderContract<T> {\n      const Filter = filter || this.$filter()\n      return new Filter(this.query(), input).handle()\n    }\n\n    /**\n     * Filtration scope of filterable model\n     */\n    static filtration = function (\n      this: typeof FilterableModel,\n      query,\n      input,\n      filter?: LucidFilterContract\n    ) {\n      const Filter = filter || this.$filter()\n      return new Filter(query, input).handle()\n    } as QueryScope<Model, QueryScopeCallback>\n  }\n  return FilterableModel\n}\n"],"mappings":";;;;;;;;;AAWA,eAAsB,UAAU,SAAoB;AAClD,QAAM,WAAW,MAAM,QAAQ,eAAe;AAE9C,QAAM,SAAS,aAAa,CAAC,WAAW;AACtC,WAAO,YAAY,8BAA8B;AACjD,WAAO,WAAW,8BAA8B;AAAA,EAClD,CAAC;AACH;;;ACTA,OAAO,eAAe;AAGtB,SAAS,mBAAsB;AAC7B,SAAO,CAAC,OAAU;AAAA,EAAC;AACrB;AASO,IAAM,kBAAN,MAA6C;AAAA,EAUlD,YACS,QACA,QACP;AAFO;AACA;AAEP,SAAK,SAAS,gBAAgB,iBAAiB,KAAK,MAAM;AAC1D,SAAK,aAAa,KAAK,YAAY;AAAA,EACrC;AAAA,EAEA,SAAc;AACZ,QAAI,KAAK,SAAS,OAAO,KAAK,UAAU,YAAY;AAClD,WAAK,MAAM,KAAK,MAAM;AAAA,IACxB;AACA,SAAK,eAAe;AAEpB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,gBAAgB,QAAyB;AACvC,UAAM,QAAQ,KAAK,WAAW,QAAQ,MAAM;AAE5C,UAAM,gBAAgB,UAAU;AAChC,QAAI,cAAe,MAAK,WAAW,OAAO,OAAO,CAAC;AAElD,WAAO;AAAA,EACT;AAAA,EAEA,iBAAuB;AACrB,eAAW,OAAO,KAAK,QAAQ;AAC7B,YAAM,SAAS,KAAK,iBAAiB,GAAG;AAExC,YAAM,UAAU;AAChB,YAAM,QAAiB,KAAK,OAAO,OAAO;AAE1C,UAAI,KAAK,kBAAkB,MAAM,GAAG;AAClC;AAAC,QAAC,KAAK,MAAoB,EAAe,KAAK;AAAA,MACjD;AAAA,IACF;AAAA,EACF;AAAA,EAEA,iBAAiB,KAAqB;AACpC,UAAM,aAAa,KAAK,YAAY,SAAS,IAAI,QAAQ,kBAAkB,IAAI,IAAI;AACnF,WAAO,KAAK,YAAY,YAAY,UAAU,UAAU,IAAI;AAAA,EAC9D;AAAA,EAEA,OAAO,iBAAiB,OAAuB;AAC7C,UAAM,gBAAgB,CAAC;AAEvB,eAAW,OAAO,OAAO;AACvB,YAAM,UAAU;AAChB,YAAM,QAAQ,MAAM,OAAO;AAE3B,UAAI,UAAU,MAAM,UAAU,QAAQ,UAAU,QAAW;AACzD,sBAAc,OAAO,IAAI;AAAA,MAC3B;AAAA,IACF;AACA,WAAO;AAAA,EACT;AAAA,EAEA,kBAAkB,QAAyB;AACzC,UAAM,YAAY;AAElB,WACE,CAAC,CAAC,KAAK,SAAS,KAChB,OAAO,KAAK,SAAS,MAAM,cAC3B,CAAC,KAAK,qBAAqB,MAAM;AAAA,EAErC;AAAA,EAEA,qBAAqB,QAAyB;AAC5C,WAAO,KAAK,WAAW,SAAS,MAAM;AAAA,EACxC;AACF;AA7EE,cAJW,iBAIJ,aAAsB,CAAC;AAC9B,cALW,iBAKJ,UAAkB;AACzB,cANW,iBAMJ,aAAqB;AANjB,kBAAN;AAAA,EADN,iBAAsC;AAAA,GAC1B;;;ACLN,IAAM,aAAa,CACxB,eACG;AAAA,EACH,MAAM,wBAAwB,WAAW;AAAA;AAAA;AAAA;AAAA,IAMvC,OAAO,OAKL,OACA,QAC8B;AAC9B,YAAM,SAAS,UAAU,KAAK,QAAQ;AACtC,aAAO,IAAI,OAAO,KAAK,MAAM,GAAG,KAAK,EAAE,OAAO;AAAA,IAChD;AAAA;AAAA;AAAA;AAAA,IAKA,OAAO,aAAa,SAElB,OACA,OACA,QACA;AACA,YAAM,SAAS,UAAU,KAAK,QAAQ;AACtC,aAAO,IAAI,OAAO,OAAO,KAAK,EAAE,OAAO;AAAA,IACzC;AAAA,EACF;AACA,SAAO;AACT;","names":[]}